const { Scenes, Markup } = require('telegraf');
const Order = require('../models/Order');

const orderScene = new Scenes.WizardScene(
  'order-wizard',

  // 1. –ì–æ—Ä–æ–¥
  async (ctx) => {
    ctx.wizard.state.data = {};
    await ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏:', Markup.keyboard(['–ú–æ—Å–∫–≤–∞', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥']).oneTime().resize());
    return ctx.wizard.next();
  },

  // 2. –¢–∏–ø –ø—Ä–æ–¥—É–∫—Ç–∞
  async (ctx) => {
    const city = ctx.message.text;
    if (!['–ú–æ—Å–∫–≤–∞', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥'].includes(city)) return ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞.');
    ctx.wizard.state.data.city = city;

    await ctx.reply('–ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è?', Markup.keyboard(['–ë–µ—Ç–æ–Ω', '–†–∞—Å—Ç–≤–æ—Ä']).oneTime().resize());
    return ctx.wizard.next();
  },

  // 3. –¢–∏–ø –Ω–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—è
  async (ctx) => {
    const type = ctx.message.text;
    if (!['–ë–µ—Ç–æ–Ω', '–†–∞—Å—Ç–≤–æ—Ä'].includes(type)) return ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.');

    ctx.wizard.state.data.productType = type;

    if (type === '–†–∞—Å—Ç–≤–æ—Ä') {
      ctx.wizard.state.data.fillerType = '–ù–µ—Ç';
      return ctx.wizard.selectStep(4); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—ã–±–æ—Ä —â–µ–±–Ω—è
    }

    const city = ctx.wizard.state.data.city;
    if (city === '–ú–æ—Å–∫–≤–∞') {
      await ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –Ω–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—è:', Markup.keyboard(['–ì—Ä–∞–Ω–∏—Ç', '–ì—Ä–∞–≤–∏–π']).oneTime().resize());
    } else {
      ctx.wizard.state.data.fillerType = '–ì—Ä–∞–Ω–∏—Ç';
      return ctx.wizard.selectStep(4); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—ã–±–æ—Ä, —Ç.–∫. —Ç–æ–ª—å–∫–æ –≥—Ä–∞–Ω–∏—Ç
    }

    return ctx.wizard.next();
  },

  // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—å (—Ç–æ–ª—å–∫–æ –¥–ª—è –ú–æ—Å–∫–≤—ã)
  async (ctx) => {
    if (!ctx.wizard.state.data.fillerType) {
      const filler = ctx.message.text;
      if (!['–ì—Ä–∞–Ω–∏—Ç', '–ì—Ä–∞–≤–∏–π'].includes(filler)) return ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –Ω–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—è.');
      ctx.wizard.state.data.fillerType = filler;
    }

    await ctx.reply('–í–≤–µ–¥–∏—Ç–µ –º–∞—Ä–∫—É –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú300):');
    return ctx.wizard.next();
  },

  // 5. –ú–∞—Ä–∫–∞
  async (ctx) => {
    ctx.wizard.state.data.materialGrade = ctx.message.text;
    await ctx.reply('–£–∫–∞–∂–∏—Ç–µ –æ–±—ä—ë–º –≤ –º¬≥:', Markup.keyboard([
      ['–ü–æ–º–æ—â—å –≤ —Ä–∞—Å—á—ë—Ç–µ']
    ]).oneTime().resize());
    return ctx.wizard.next();
  },

 // 6. –û–±—ä—ë–º
async (ctx) => {
  const text = ctx.message.text;

  if (text === '–ü–æ–º–æ—â—å –≤ —Ä–∞—Å—á—ë—Ç–µ') {
    await ctx.reply('‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω—É –æ–ø–∞–ª—É–±–∫–∏ –≤ –º–µ—Ç—Ä–∞—Ö:');
    ctx.wizard.state.volumeCalc = {};
    return ctx.wizard.selectStep(60); // –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∫–∞—Å—Ç–æ–º–Ω—É—é –ø–æ–¥—Å—Ü–µ–Ω—É
  }

  const volume = parseFloat(text.replace(',', '.'));
  if (isNaN(volume)) {
    return ctx.reply('‚ùó –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—ä—ë–º–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–º–æ—â—å –≤ —Ä–∞—Å—á—ë—Ç–µ".');
  }

  ctx.wizard.state.data.volume = volume;
  await ctx.reply('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:');
  return ctx.wizard.next();
},
// 6.1 ‚Äî –°–ø–æ—Å–æ–± –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–∞
async (ctx) => {
  await ctx.reply('üìç –ö–∞–∫ —Ö–æ—Ç–∏—Ç–µ —É–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å?', Markup.keyboard([
    ['–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é', '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é']
  ]).oneTime().resize());

  return ctx.wizard.next();
},
// 6.2 ‚Äî –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞
async (ctx) => {
  const choice = ctx.message.text;

  if (choice === '–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é') {
    await ctx.reply('‚úèÔ∏è –£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:');
    return ctx.wizard.selectStep(7); // –∫–∞–∫ —Ä–∞–Ω—å—à–µ
  }

  if (choice === '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é') {
    await ctx.reply('üìç –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É üìé (–ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å).');
    return ctx.wizard.selectStep(6.3);
  }

  return ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.');
},
// 6.3 ‚Äî –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
async (ctx) => {
  if (!ctx.message.location) {
    return ctx.reply('‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–º–µ–Ω–Ω–æ –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–∫–∏ üìé.');
  }

  const { latitude, longitude } = ctx.message.location;

  ctx.wizard.state.data.deliveryAddress = `–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: https://maps.google.com/?q=${latitude},${longitude}`;

  await ctx.reply('üóì –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 12 –º–∞—è 10:00):');
  return ctx.wizard.selectStep(8); // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –∞–¥—Ä–µ—Å–∞
},

  // 7. –ê–¥—Ä–µ—Å
  async (ctx) => {
    ctx.wizard.state.data.deliveryAddress = ctx.message.text;
    await ctx.reply('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 12 –º–∞—è 10:00):');
    return ctx.wizard.next();
  },

  // 8. –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
  async (ctx) => {
    ctx.wizard.state.data.deliveryDateTime = ctx.message.text;
    await ctx.reply('–°–ø–æ—Å–æ–± –ø–æ–¥–∞—á–∏:', Markup.keyboard(['–°–∞–º–æ—Å–ª–∏–≤', '–ê–≤—Ç–æ–±–µ—Ç–æ–Ω–æ–Ω–∞—Å–æ—Å']).oneTime().resize());
    return ctx.wizard.next();
  },

  // 9. –°–ø–æ—Å–æ–± –ø–æ–¥–∞—á–∏ –∏ –Ω–∞—Å–æ—Å (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω)
  async (ctx) => {
    const method = ctx.message.text;
    if (!['–°–∞–º–æ—Å–ª–∏–≤', '–ê–≤—Ç–æ–±–µ—Ç–æ–Ω–æ–Ω–∞—Å–æ—Å'].includes(method)) return ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–¥–∞—á–∏.');

    ctx.wizard.state.data.deliveryMethod = method;

    if (method === '–ê–≤—Ç–æ–±–µ—Ç–æ–Ω–æ–Ω–∞—Å–æ—Å') {
      await ctx.reply('–£–∫–∞–∂–∏—Ç–µ –¥–ª–∏–Ω—É —Å—Ç—Ä–µ–ª—ã:', Markup.keyboard(['22–º', '24–º', '28–º', '32–º', '36–º', '40–º', '52–º']).oneTime().resize());
      return ctx.wizard.next();
    }

    ctx.wizard.state.data.pumpLength = '–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è';
    return ctx.wizard.selectStep(10);
  },

  // 10. –î–ª–∏–Ω–∞ —Å—Ç—Ä–µ–ª—ã –Ω–∞—Å–æ—Å–∞
  async (ctx) => {
    ctx.wizard.state.data.pumpLength = ctx.message.text;
    await ctx.reply('–í—ã —Ñ–∏–∑–ª–∏—Ü–æ –∏–ª–∏ —é—Ä–ª–∏—Ü–æ?', Markup.keyboard(['–§–∏–∑–ª–∏—Ü–æ', '–Æ—Ä–ª–∏—Ü–æ']).oneTime().resize());
    return ctx.wizard.next();
  },

  // 11. –¢–∏–ø –∫–ª–∏–µ–Ω—Ç–∞
  async (ctx) => {
    ctx.wizard.state.data.customerType = ctx.message.text;
    await ctx.reply('–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:', Markup.keyboard(['–ù–∞–ª–∏—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç', '–ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç']).oneTime().resize());
    return ctx.wizard.next();
  },

  // 12. –û–ø–ª–∞—Ç–∞
  async (ctx) => {
    ctx.wizard.state.data.paymentMethod = ctx.message.text;
    await ctx.reply('–í–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω:');
    return ctx.wizard.next();
  },

  // 13. –¢–µ–ª–µ—Ñ–æ–Ω
async (ctx) => {
  const phone = ctx.message.text.trim();

  // –ü—Ä–æ—Å—Ç–æ–π —à–∞–±–ª–æ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤
  const phoneRegex = /^(\+7|8)?[\s-]?\(?\d{3}\)?[\s-]?\d{3}[\s-]?\d{2}[\s-]?\d{2}$/;

  if (!phoneRegex.test(phone)) {
    await ctx.reply('‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ü—Ä–∏–º–µ—Ä: +7 999 123-45-67');
    return;
  }

  ctx.wizard.state.data.phoneNumber = phone;
  await ctx.reply('–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ "–Ω–µ—Ç":');
  return ctx.wizard.next();
},
// 60. –í–≤–æ–¥ –¥–ª–∏–Ω—ã
async (ctx) => {
  const length = parseFloat(ctx.message.text.replace(',', '.'));
  if (isNaN(length)) return ctx.reply('‚ùó –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ (–¥–ª–∏–Ω—É –≤ –º–µ—Ç—Ä–∞—Ö)');
  ctx.wizard.state.volumeCalc.length = length;
  await ctx.reply('–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ —à–∏—Ä–∏–Ω—É –æ–ø–∞–ª—É–±–∫–∏ –≤ –º–µ—Ç—Ä–∞—Ö:');
  return ctx.wizard.selectStep(61);
},

// 61. –í–≤–æ–¥ —à–∏—Ä–∏–Ω—ã
async (ctx) => {
  const width = parseFloat(ctx.message.text.replace(',', '.'));
  if (isNaN(width)) return ctx.reply('‚ùó –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ (—à–∏—Ä–∏–Ω—É –≤ –º–µ—Ç—Ä–∞—Ö)');
  ctx.wizard.state.volumeCalc.width = width;
  await ctx.reply('–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –≤—ã—Å–æ—Ç—É (–∏–ª–∏ –≥–ª—É–±–∏–Ω—É) –æ–ø–∞–ª—É–±–∫–∏ –≤ –º–µ—Ç—Ä–∞—Ö:');
  return ctx.wizard.selectStep(62);
},

// 62. –í–≤–æ–¥ –≤—ã—Å–æ—Ç—ã –∏ —Ä–∞—Å—á—ë—Ç
async (ctx) => {
  const height = parseFloat(ctx.message.text.replace(',', '.'));
  if (isNaN(height)) return ctx.reply('‚ùó –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ (–≤—ã—Å–æ—Ç—É –≤ –º–µ—Ç—Ä–∞—Ö)');

  const { length, width } = ctx.wizard.state.volumeCalc;
  const volume = +(length * width * height).toFixed(2);
  ctx.wizard.state.data.volume = volume;

  await ctx.reply(`üìê –†–∞—Å—á—ë—Ç–Ω—ã–π –æ–±—ä—ë–º: *${volume} –º¬≥*`, {
    parse_mode: 'Markdown'
  });

  await ctx.reply('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –æ–±—ä—ë–º?', Markup.keyboard([
    ['‚úÖ –î–∞', '‚ùå –ù–µ—Ç, –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é']
  ]).oneTime().resize());

  return ctx.wizard.selectStep(63);
},
// 63. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±—ä—ë–º–∞
async (ctx) => {
  const answer = ctx.message.text;

  if (answer === '‚úÖ –î–∞') {
    await ctx.reply('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:');
    return ctx.wizard.selectStep(7); // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
  }

  if (answer === '‚ùå –ù–µ—Ç, –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é') {
    await ctx.reply('–•–æ—Ä–æ—à–æ, –≤–≤–µ–¥–∏—Ç–µ –æ–±—ä—ë–º –≤ –º¬≥:', Markup.removeKeyboard());
    return ctx.wizard.selectStep(6); // –í–æ–∑–≤—Ä–∞—Ç –∫ —Ä—É—á–Ω–æ–º—É –≤–≤–æ–¥—É
  }

  return ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ "‚úÖ –î–∞" –∏–ª–∏ "‚ùå –ù–µ—Ç, –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é".');
},
  // 14. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
async (ctx) => {
  ctx.wizard.state.data.comment = ctx.message.text;
  ctx.wizard.state.data.telegramId = ctx.from.id;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞—è–≤–∫—É –≤ MongoDB
  await Order.create(ctx.wizard.state.data);

  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
  try {
    await ctx.telegram.sendMessage(
      ctx.from.id,
      '‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞ –∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ –≤ —Ä–∞–±–æ—Ç—É! –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –æ–±—Ä–∞—Ç–∏–ª–∏—Å—å –∫ –Ω–∞–º.'
    );
  } catch (err) {
    console.error('‚ùó –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É:', err);
  }

  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–µ–±–µ (–∏–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä—É)
  const adminId = 7811172186;
  const data = ctx.wizard.state.data;

  await ctx.telegram.sendMessage(adminId, 
    `üì¨ *–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞:*\n\n` +
    `üèô *–ì–æ—Ä–æ–¥:* ${data.city}\n` +
    `üß± *–¢–∏–ø:* ${data.productType} (${data.fillerType})\n` +
    `üè∑ *–ú–∞—Ä–∫–∞:* ${data.materialGrade}\n` +
    `üì¶ *–û–±—ä—ë–º:* ${data.volume} –º¬≥\n` +
    `üìç *–ê–¥—Ä–µ—Å:* ${data.deliveryAddress}\n` +
    `üïí *–î–∞—Ç–∞/–≤—Ä–µ–º—è:* ${data.deliveryDateTime}\n` +
    `üöö *–ü–æ–¥–∞—á–∞:* ${data.deliveryMethod} (${data.pumpLength})\n` +
    `üë§ *–ö–ª–∏–µ–Ω—Ç:* ${data.customerType}, ${data.phoneNumber}\n` +
    `üßæ *–û–ø–ª–∞—Ç–∞:* ${data.paymentMethod}\n` +
    `üí¨ *–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:* ${data.comment || '‚Äî'}`,
    { parse_mode: 'Markdown' }
  );

  return ctx.scene.leave();
},
)
module.exports = orderScene;